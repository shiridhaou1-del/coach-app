<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚ØªØ§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#5D5CDE',
                        'dark-bg': '#181818',
                        'glass': 'rgba(255, 255, 255, 0.1)',
                        'glass-dark': 'rgba(0, 0, 0, 0.2)'
                    },
                    fontFamily: {
                        'arabic': ['Tajawal', 'Arial', 'sans-serif']
                    },
                    backdropBlur: {
                        'xs': '2px',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@200;300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', Arial, sans-serif;
        }
        
        .floating-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        
        .floating-icon {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .control-panel.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        
        .canvas-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .canvas-overlay.drawing {
            pointer-events: all;
        }
        
        .sidebar-gallery {
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .sidebar-gallery.open {
            transform: translateX(0);
        }
        
        .tactical-hud {
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.1), rgba(0, 0, 0, 0.8));
            backdrop-filter: blur(20px);
        }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-hidden">
    <!-- Floating Icons Background -->
    <div class="floating-icons" id="floatingIcons"></div>
    
    <!-- Main Container -->
    <div class="relative w-screen h-screen">
        
        <!-- Launchpad Screen -->
        <div id="launchpadScreen" class="absolute inset-0 flex flex-col items-center justify-center p-8">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4 animate-pulse">ğŸ¥‹</div>
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-blue-400 bg-clip-text text-transparent">
                    Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚ØªØ§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠØ©
                </h1>
                <p class="text-gray-400 text-lg">Ø§Ù„Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯</p>
            </div>
            
            <div class="glass-morphism rounded-3xl p-8 max-w-md w-full text-center">
                <div class="border-2 border-dashed border-gray-500 rounded-2xl p-8 transition-colors hover:border-primary"
                     id="dropZone">
                    <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-gray-400"></i>
                    <p class="text-gray-300 mb-4">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‡Ù†Ø§</p>
                    <input type="file" id="videoInput" accept="video/*" class="hidden">
                    <button onclick="document.getElementById('videoInput').click()" 
                            class="bg-primary hover:bg-purple-600 px-6 py-3 rounded-xl text-white font-medium transition-colors">
                        Ø§Ø®ØªØ± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Workspace -->
        <div id="workspaceScreen" class="absolute inset-0 hidden">
            <!-- Top Control Bar -->
            <div id="topControls" class="absolute top-4 left-4 right-4 z-20 control-panel">
                <div class="glass-morphism rounded-2xl p-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <select id="sportSelect" class="bg-glass border border-gray-500 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-primary">
                            <option value="sanda">Sanda (San Shou)</option>
                            <option value="mma">MMA</option>
                            <option value="kickboxing">Kickboxing</option>
                            <option value="karate">Karate</option>
                            <option value="taekwondo">Taekwondo</option>
                            <option value="wushu">Wushu Taolu</option>
                            <option value="judo">Judo</option>
                            <option value="boxing">Boxing</option>
                            <option value="muaythai">Muay Thai</option>
                        </select>
                        
                        <div class="flex items-center gap-2">
                            <button id="penTool" class="p-2 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button id="eraseTool" class="p-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition-colors">
                                <i class="fas fa-eraser"></i>
                            </button>
                            <button id="bluePen" class="p-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition-colors">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button id="clearCanvas" class="p-2 rounded-lg bg-yellow-600 text-white hover:bg-yellow-700 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="secretHubBtn" class="p-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700 transition-colors">
                        <i class="fas fa-lock"></i>
                    </button>
                </div>
            </div>

            <!-- Video Container -->
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="relative max-w-full max-h-full">
                    <video id="mainVideo" class="max-w-full max-h-full rounded-lg shadow-2xl" 
                           controls controlsList="nodownload" 
                           preload="metadata"
                           playsinline
                           muted
                           x-webkit-airplay="allow">
                        Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    </video>
                    
                    <!-- Video Loading Overlay -->
                    <div id="videoLoading" class="absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center rounded-lg hidden">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-white">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...</p>
                            <div id="loadingProgress" class="w-64 bg-gray-700 rounded-full h-2 mt-4">
                                <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <canvas id="drawingCanvas" class="canvas-overlay rounded-lg"></canvas>
                </div>
            </div>

            <!-- Bottom Control Bar -->
            <div id="bottomControls" class="absolute bottom-4 left-4 right-4 z-20 control-panel">
                <div class="glass-morphism rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-4">
                        <button id="playPauseBtn" class="p-3 rounded-full bg-primary text-white hover:bg-purple-600 transition-colors">
                            <i class="fas fa-play"></i>
                        </button>
                        
                        <div class="flex items-center gap-4">
                            <button onclick="changeSpeed(0.25)" class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">0.25x</button>
                            <button onclick="changeSpeed(0.5)" class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">0.5x</button>
                            <button onclick="changeSpeed(1)" class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">1x</button>
                            <button onclick="changeSpeed(2)" class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">2x</button>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <button id="snapshotBtn" class="p-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition-colors">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button id="analyzeBtn" class="px-6 py-2 bg-gradient-to-r from-primary to-purple-600 text-white rounded-xl hover:from-purple-600 hover:to-primary transition-all font-medium">
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹
                            </button>
                            <button id="galleryBtn" class="p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">
                                <i class="fas fa-images"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <input type="range" id="videoSeeker" min="0" max="100" value="0" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                        <div id="timeDisplay" class="text-center text-sm text-gray-400 mt-2">
                            00:00 / 00:00
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gallery Sidebar -->
        <div id="gallerySidebar" class="sidebar-gallery absolute top-0 right-0 w-80 h-full z-30">
            <div class="glass-morphism h-full p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold">Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù„Ù‚Ø·Ø§Øª</h3>
                    <button id="closeSidebar" class="p-2 rounded-lg bg-red-500 text-white hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="snapshotGallery" class="space-y-4 overflow-y-auto max-h-full">
                    <!-- Snapshots will be added here -->
                </div>
            </div>
        </div>

        <!-- Secret Hub Modal -->
        <div id="secretHubModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40">
            <div class="glass-morphism rounded-3xl p-8 max-w-md w-full mx-4">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">ğŸ”</div>
                    <h3 class="text-2xl font-bold mb-2">Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø³Ø±ÙŠ</h3>
                    <p class="text-gray-400">Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„</p>
                </div>
                
                <div class="space-y-4">
                    <input type="password" id="secretPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" 
                           class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white focus:outline-none focus:border-primary">
                    <div class="flex gap-3">
                        <button id="accessSecret" class="flex-1 bg-primary hover:bg-purple-600 px-6 py-3 rounded-xl text-white font-medium">
                            Ø¯Ø®ÙˆÙ„
                        </button>
                        <button id="cancelSecret" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl text-white">
                            Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secret Hub Screen -->
        <div id="secretHubScreen" class="absolute inset-0 hidden bg-slate-950">
            <div class="p-8">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold">ğŸ•µï¸ Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„Ø³Ø±ÙŠ</h2>
                    <button id="exitSecret" class="p-3 rounded-lg bg-red-500 text-white hover:bg-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Archives Section -->
                    <div class="glass-morphism rounded-2xl p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i class="fas fa-archive"></i>
                            Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                        </h3>
                        <div id="archivesList" class="space-y-4 max-h-96 overflow-y-auto">
                            <p class="text-gray-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</p>
                        </div>
                    </div>
                    
                    <!-- Scouting Section -->
                    <div class="glass-morphism rounded-2xl p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <i class="fas fa-search"></i>
                            Ø§Ù„Ø§Ø³ØªØ®Ø¨Ø§Ø±Ø§Øª
                        </h3>
                        <div class="space-y-4">
                            <textarea id="scoutingQuery" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ø¹Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³ Ø£Ùˆ Ø§Ù„ØªÙƒØªÙŠÙƒ..." 
                                    class="w-full h-32 px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white resize-none focus:outline-none focus:border-primary"></textarea>
                            <button id="scoutBtn" class="w-full bg-gradient-to-r from-primary to-blue-500 hover:from-blue-500 hover:to-primary px-6 py-3 rounded-xl text-white font-medium">
                                Ø¨Ø­Ø« Ø§Ø³ØªØ®Ø¨Ø§Ø±Ø§ØªÙŠ
                            </button>
                            <div id="scoutingResults" class="max-h-64 overflow-y-auto bg-gray-800 rounded-xl p-4 hidden">
                                <!-- Results will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tactical HUD Modal -->
        <div id="tacticalHUD" class="fixed inset-0 tactical-hud hidden items-center justify-center z-50">
            <div class="w-full h-full max-w-6xl mx-4 overflow-y-auto">
                <div class="glass-morphism rounded-3xl p-8 m-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold flex items-center gap-3">
                            <div class="text-4xl">ğŸ¯</div>
                            ØªØ­Ù„ÙŠÙ„ ØªÙƒØªÙŠÙƒÙŠ Ù…ØªÙ‚Ø¯Ù…
                        </h2>
                        <button id="closeHUD" class="p-3 rounded-full bg-red-500 text-white hover:bg-red-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Analysis Results -->
                        <div class="space-y-6">
                            <div class="glass-morphism rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4 text-blue-400">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹</h3>
                                <div id="sequenceAnalysis" class="text-gray-300 loading">
                                    <div class="flex items-center gap-2">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="glass-morphism rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4 text-green-400">âš¡ ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„</h3>
                                <div id="matchEvolution" class="text-gray-300 loading">
                                    <div class="flex items-center gap-2">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="glass-morphism rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4 text-yellow-400">âš–ï¸ Ø­ÙƒÙ… Ø§Ù„Ø³Ø§Ø­Ø©</h3>
                                <div id="refereeJudgment" class="text-gray-300 loading">
                                    <div class="flex items-center gap-2">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
                                    </div>
                                </div>
                            </div>
                            
                            <div class="glass-morphism rounded-2xl p-6">
                                <h3 class="text-xl font-bold mb-4 text-red-400">ğŸ¥Š ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø¨</h3>
                                <div id="cornerAdvice" class="text-gray-300 loading">
                                    <div class="flex items-center gap-2">
                                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 flex gap-4">
                        <button id="saveToArchive" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 px-6 py-3 rounded-xl text-white font-medium">
                            Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                        </button>
                        <button id="newAnalysis" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-xl text-white">
                            ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat with AI -->
        <div id="aiChatModal" class="fixed bottom-4 right-4 w-96 glass-morphism rounded-2xl p-4 hidden z-30">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ</h3>
                <button id="closeChatModal" class="p-1 rounded text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="chatMessages" class="h-64 overflow-y-auto mb-4 space-y-2">
                <!-- Messages will appear here -->
            </div>
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ..." 
                       class="flex-1 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:border-primary">
                <button id="sendChatBtn" class="px-4 py-2 bg-primary hover:bg-purple-600 rounded-lg text-white">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global variables
        let currentVideo = null;
        let canvas = null;
        let ctx = null;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#ff0000';
        let snapshots = [];
        let analysisHistory = [];
        let controlsTimer = null;

        // Initialize floating icons
        function createFloatingIcons() {
            const container = document.getElementById('floatingIcons');
            const icons = ['ğŸ¥‹', 'ğŸ¥Š', 'âš¡', 'ğŸ¯', 'ğŸ’ª', 'ğŸ†', 'â­', 'ğŸ”¥'];
            
            setInterval(() => {
                if (container.children.length < 15) {
                    const icon = document.createElement('div');
                    icon.className = 'floating-icon';
                    icon.textContent = icons[Math.floor(Math.random() * icons.length)];
                    icon.style.left = Math.random() * 100 + '%';
                    icon.style.animationDuration = (15 + Math.random() * 10) + 's';
                    icon.style.animationDelay = Math.random() * 2 + 's';
                    container.appendChild(icon);
                    
                    setTimeout(() => {
                        if (icon.parentNode) {
                            icon.parentNode.removeChild(icon);
                        }
                    }, 25000);
                }
            }, 2000);
        }

        // Initialize app
        function initializeApp() {
            createFloatingIcons();
            setupVideoUpload();
            setupVideoControls();
            setupDrawingTools();
            setupSecretHub();
            setupAnalysis();
            setupGallery();
            setupControlsAutoHide();
        }

        // Video upload functionality
        function setupVideoUpload() {
            const dropZone = document.getElementById('dropZone');
            const videoInput = document.getElementById('videoInput');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#5D5CDE';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('video/')) {
                    loadVideo(files[0]);
                }
            });
            
            videoInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    loadVideo(e.target.files[0]);
                }
            });
        }

        function loadVideo(file) {
            const url = URL.createObjectURL(file);
            currentVideo = document.getElementById('mainVideo');
            const loadingOverlay = document.getElementById('videoLoading');
            const progressBar = document.getElementById('progressBar');
            
            // Show loading overlay
            loadingOverlay.classList.remove('hidden');
            
            // Setup video loading events
            currentVideo.addEventListener('loadstart', () => {
                loadingOverlay.classList.remove('hidden');
                progressBar.style.width = '10%';
            });
            
            currentVideo.addEventListener('progress', () => {
                if (currentVideo.buffered.length > 0) {
                    const buffered = currentVideo.buffered.end(currentVideo.buffered.length - 1);
                    const duration = currentVideo.duration || 1;
                    const progress = (buffered / duration) * 100;
                    progressBar.style.width = Math.min(progress, 90) + '%';
                }
            });
            
            currentVideo.addEventListener('canplaythrough', () => {
                progressBar.style.width = '100%';
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                }, 500);
            });
            
            currentVideo.addEventListener('waiting', () => {
                loadingOverlay.classList.remove('hidden');
            });
            
            currentVideo.addEventListener('canplay', () => {
                loadingOverlay.classList.add('hidden');
            });
            
            // Handle video errors
            currentVideo.addEventListener('error', () => {
                loadingOverlay.innerHTML = `
                    <div class="text-center">
                        <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
                        <p class="text-white mb-4">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</p>
                        <button onclick="location.reload()" class="bg-primary hover:bg-purple-600 px-6 py-2 rounded-xl text-white">
                            Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            });
            
            // Optimize video settings
            currentVideo.preload = 'metadata';
            currentVideo.crossOrigin = 'anonymous';
            
            // Set video source
            currentVideo.src = url;
            
            // Switch to workspace
            document.getElementById('launchpadScreen').classList.add('hidden');
            document.getElementById('workspaceScreen').classList.remove('hidden');
            
            // Initialize canvas
            setupCanvas();
            setupVideoPerformanceOptimization();
        }
        
        function setupVideoPerformanceOptimization() {
            const video = currentVideo;
            
            // Buffer optimization
            let bufferCheckInterval;
            
            video.addEventListener('loadedmetadata', () => {
                // Auto-adjust quality based on file size
                const fileSize = video.duration * 1000; // rough estimation
                if (fileSize > 50000) { // Large files
                    video.preload = 'none';
                    showAlert('ÙÙŠØ¯ÙŠÙˆ ÙƒØ¨ÙŠØ± Ø§Ù„Ø­Ø¬Ù… - Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ù…Ø«Ù„');
                }
            });
            
            // Monitor buffering
            video.addEventListener('play', () => {
                bufferCheckInterval = setInterval(() => {
                    if (video.buffered.length > 0) {
                        const currentTime = video.currentTime;
                        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                        const bufferHealth = bufferedEnd - currentTime;
                        
                        // If buffer is low, pause briefly to load more
                        if (bufferHealth < 2 && !video.paused) {
                            console.log('Buffer health low, optimizing...');
                            // Could implement intelligent buffering here
                        }
                    }
                }, 1000);
            });
            
            video.addEventListener('pause', () => {
                clearInterval(bufferCheckInterval);
            });
            
            // Memory cleanup
            video.addEventListener('ended', () => {
                clearInterval(bufferCheckInterval);
            });
            
            // Handle quality degradation for smooth playback
            video.addEventListener('stalled', () => {
                showAlert('Ø¬Ø§Ø±ÙŠ ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...');
            });
        }

        function setupCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            const video = document.getElementById('mainVideo');
            
            function resizeCanvas() {
                const rect = video.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = rect.height;
                canvas.style.width = rect.width + 'px';
                canvas.style.height = rect.height + 'px';
            }
            
            video.addEventListener('loadedmetadata', resizeCanvas);
            window.addEventListener('resize', resizeCanvas);
            
            // Drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        // Video controls
        function setupVideoControls() {
            const video = document.getElementById('mainVideo');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const videoSeeker = document.getElementById('videoSeeker');
            const timeDisplay = document.getElementById('timeDisplay');
            
            playPauseBtn.addEventListener('click', togglePlay);
            
            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('loadedmetadata', () => {
                videoSeeker.max = video.duration;
            });
            
            videoSeeker.addEventListener('input', (e) => {
                video.currentTime = e.target.value;
            });
        }

        function togglePlay() {
            const video = document.getElementById('mainVideo');
            const icon = document.querySelector('#playPauseBtn i');
            
            if (video.paused) {
                video.play();
                icon.className = 'fas fa-pause';
            } else {
                video.pause();
                icon.className = 'fas fa-play';
            }
        }

        function changeSpeed(speed) {
            const video = document.getElementById('mainVideo');
            video.playbackRate = speed;
        }

        function updateProgress() {
            const video = document.getElementById('mainVideo');
            const seeker = document.getElementById('videoSeeker');
            const timeDisplay = document.getElementById('timeDisplay');
            
            seeker.value = video.currentTime;
            
            const current = formatTime(video.currentTime);
            const duration = formatTime(video.duration);
            timeDisplay.textContent = `${current} / ${duration}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Drawing tools
        function setupDrawingTools() {
            document.getElementById('penTool').addEventListener('click', () => setTool('pen', '#ff0000'));
            document.getElementById('bluePen').addEventListener('click', () => setTool('pen', '#0000ff'));
            document.getElementById('eraseTool').addEventListener('click', () => setTool('eraser'));
            document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
        }

        function setTool(tool, color = '#ff0000') {
            currentTool = tool;
            currentColor = color;
            
            if (tool === 'pen') {
                canvas.classList.add('drawing');
                canvas.style.cursor = 'crosshair';
            } else if (tool === 'eraser') {
                canvas.classList.add('drawing');
                canvas.style.cursor = 'grab';
            }
        }

        function startDrawing(e) {
            if (currentTool === 'none') return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function draw(e) {
            if (!isDrawing || currentTool === 'none') return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = currentTool === 'eraser' ? 20 : 3;
            ctx.lineCap = 'round';
            
            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = currentColor;
            }
            
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Controls auto-hide
        function setupControlsAutoHide() {
            const workspace = document.getElementById('workspaceScreen');
            const topControls = document.getElementById('topControls');
            const bottomControls = document.getElementById('bottomControls');
            const video = document.getElementById('mainVideo');
            
            function showControls() {
                topControls.classList.remove('hidden');
                bottomControls.classList.remove('hidden');
                
                clearTimeout(controlsTimer);
                controlsTimer = setTimeout(() => {
                    // Don't hide controls if hovering over them or video controls
                    if (!topControls.matches(':hover') && !bottomControls.matches(':hover') && !video.matches(':hover')) {
                        topControls.classList.add('hidden');
                        bottomControls.classList.add('hidden');
                    }
                }, 3000);
            }
            
            function hideControls() {
                clearTimeout(controlsTimer);
                controlsTimer = setTimeout(() => {
                    if (!topControls.matches(':hover') && !bottomControls.matches(':hover') && !video.matches(':hover')) {
                        topControls.classList.add('hidden');
                        bottomControls.classList.add('hidden');
                    }
                }, 1000);
            }
            
            // Show controls on mouse movement, but only in video area
            video.addEventListener('mousemove', showControls);
            video.addEventListener('mouseenter', showControls);
            video.addEventListener('mouseleave', hideControls);
            
            workspace.addEventListener('touchstart', showControls);
            
            // Keep controls visible when interacting with them
            [topControls, bottomControls].forEach(control => {
                control.addEventListener('mouseenter', () => {
                    clearTimeout(controlsTimer);
                    control.classList.remove('hidden');
                });
                control.addEventListener('mouseleave', hideControls);
            });
            
            // Always show controls initially
            showControls();
        }

        // Gallery functionality
        function setupGallery() {
            document.getElementById('snapshotBtn').addEventListener('click', takeSnapshot);
            document.getElementById('galleryBtn').addEventListener('click', openGallery);
            document.getElementById('closeSidebar').addEventListener('click', closeGallery);
        }

        function takeSnapshot() {
            const video = document.getElementById('mainVideo');
            if (video.paused || video.ended) {
                showAlert('ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù‚Ø¨Ù„ Ø£Ø®Ø° Ù„Ù‚Ø·Ø©');
                return;
            }
            
            // Create canvas to capture video frame
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            
            captureCtx.drawImage(video, 0, 0);
            
            // Also capture drawing overlay
            if (canvas.width > 0 && canvas.height > 0) {
                captureCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 
                                   0, 0, captureCanvas.width, captureCanvas.height);
            }
            
            const imageData = captureCanvas.toDataURL('image/jpeg', 0.8);
            const timestamp = video.currentTime;
            const sport = document.getElementById('sportSelect').value;
            
            const snapshot = {
                id: Date.now(),
                image: imageData,
                timestamp,
                sport,
                time: formatTime(timestamp)
            };
            
            snapshots.push(snapshot);
            addSnapshotToGallery(snapshot);
            
            showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù„Ù‚Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }

        function addSnapshotToGallery(snapshot) {
            const gallery = document.getElementById('snapshotGallery');
            
            const item = document.createElement('div');
            item.className = 'glass-morphism rounded-xl p-4';
            item.innerHTML = `
                <img src="${snapshot.image}" alt="Ù„Ù‚Ø·Ø© ${snapshot.time}" class="w-full h-32 object-cover rounded-lg mb-2">
                <div class="text-sm">
                    <p class="font-medium">${snapshot.time}</p>
                    <p class="text-gray-400">${getSportName(snapshot.sport)}</p>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="analyzeSnapshot('${snapshot.id}')" class="flex-1 px-3 py-1 bg-primary hover:bg-purple-600 rounded text-white text-sm">
                        ØªØ­Ù„ÙŠÙ„
                    </button>
                    <button onclick="deleteSnapshot('${snapshot.id}')" class="px-3 py-1 bg-red-500 hover:bg-red-600 rounded text-white text-sm">
                        Ø­Ø°Ù
                    </button>
                </div>
            `;
            
            gallery.insertBefore(item, gallery.firstChild);
            
            // Remove empty message if exists
            const emptyMsg = gallery.querySelector('p');
            if (emptyMsg && emptyMsg.textContent.includes('Ù„Ø§ ØªÙˆØ¬Ø¯')) {
                emptyMsg.remove();
            }
        }

        function openGallery() {
            document.getElementById('gallerySidebar').classList.add('open');
        }

        function closeGallery() {
            document.getElementById('gallerySidebar').classList.remove('open');
        }

        function getSportName(sport) {
            const sports = {
                'sanda': 'Sanda',
                'mma': 'MMA',
                'kickboxing': 'Kickboxing',
                'karate': 'Karate',
                'taekwondo': 'Taekwondo',
                'wushu': 'Wushu',
                'judo': 'Judo',
                'boxing': 'Boxing',
                'muaythai': 'Muay Thai'
            };
            return sports[sport] || sport;
        }

        // Secret Hub
        function setupSecretHub() {
            document.getElementById('secretHubBtn').addEventListener('click', showSecretModal);
            document.getElementById('cancelSecret').addEventListener('click', hideSecretModal);
            document.getElementById('accessSecret').addEventListener('click', checkSecretPassword);
            document.getElementById('exitSecret').addEventListener('click', exitSecretHub);
            document.getElementById('scoutBtn').addEventListener('click', performScouting);
            
            // Enter key for password
            document.getElementById('secretPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkSecretPassword();
            });
        }

        function showSecretModal() {
            document.getElementById('secretHubModal').classList.remove('hidden');
            document.getElementById('secretHubModal').classList.add('flex');
            document.getElementById('secretPassword').focus();
        }

        function hideSecretModal() {
            document.getElementById('secretHubModal').classList.add('hidden');
            document.getElementById('secretHubModal').classList.remove('flex');
            document.getElementById('secretPassword').value = '';
        }

        function checkSecretPassword() {
            const password = document.getElementById('secretPassword').value;
            if (password === '27021972') {
                hideSecretModal();
                showSecretHub();
            } else {
                showAlert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
            }
        }

        function showSecretHub() {
            document.getElementById('workspaceScreen').classList.add('hidden');
            document.getElementById('secretHubScreen').classList.remove('hidden');
            loadArchives();
        }

        function exitSecretHub() {
            document.getElementById('secretHubScreen').classList.add('hidden');
            document.getElementById('workspaceScreen').classList.remove('hidden');
        }

        function loadArchives() {
            const archivesList = document.getElementById('archivesList');
            
            if (analysisHistory.length === 0) {
                archivesList.innerHTML = '<p class="text-gray-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©</p>';
                return;
            }
            
            archivesList.innerHTML = '';
            analysisHistory.forEach(report => {
                const item = document.createElement('div');
                item.className = 'glass-morphism rounded-xl p-4';
                item.innerHTML = `
                    <div class="flex items-start gap-3">
                        <img src="${report.snapshot}" alt="ØªÙ‚Ø±ÙŠØ±" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-medium mb-1">${report.sport} - ${report.timestamp}</h4>
                            <p class="text-sm text-gray-400 mb-2">${report.date}</p>
                            <button onclick="viewReport('${report.id}')" class="text-primary hover:text-purple-400 text-sm">
                                Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„
                            </button>
                        </div>
                    </div>
                `;
                archivesList.appendChild(item);
            });
        }

        async function performScouting() {
            const query = document.getElementById('scoutingQuery').value.trim();
            if (!query) {
                showAlert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ');
                return;
            }
            
            const resultsDiv = document.getElementById('scoutingResults');
            resultsDiv.classList.remove('hidden');
            resultsDiv.innerHTML = `
                <div class="flex items-center gap-2 text-primary">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø§Ø³ØªØ®Ø¨Ø§Ø±Ø§ØªÙŠ...
                </div>
            `;
            
            try {
                await window.Poe.sendUserMessage(`@Claude-Sonnet-4 Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ù‚ØªØ§Ù„ÙŠ Ø®Ø¨ÙŠØ±. ÙŠØ±Ø¬Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØªØ­Ù„ÙŠÙ„ Ù…ÙØµÙ„ Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶Ø§Øª Ø§Ù„Ù‚ØªØ§Ù„ÙŠØ©: ${query}`, {
                    handler: 'scouting-handler',
                    stream: true,
                    openChat: false
                });
            } catch (err) {
                resultsDiv.innerHTML = `<p class="text-red-400">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${err.message}</p>`;
            }
        }

        // Analysis functionality
        function setupAnalysis() {
            document.getElementById('analyzeBtn').addEventListener('click', () => analyzeCurrentMoment());
            document.getElementById('closeHUD').addEventListener('click', closeAnalysisHUD);
            document.getElementById('saveToArchive').addEventListener('click', saveAnalysisToArchive);
            document.getElementById('newAnalysis').addEventListener('click', newAnalysis);
        }

        async function analyzeCurrentMoment() {
            const video = document.getElementById('mainVideo');
            if (!video.src) {
                showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù…Ø­Ù…Ù„');
                return;
            }
            
            // Take snapshot for analysis
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            captureCtx.drawImage(video, 0, 0);
            
            // Also capture drawing overlay
            if (canvas.width > 0 && canvas.height > 0) {
                captureCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, 
                                   0, 0, captureCanvas.width, captureCanvas.height);
            }
            
            captureCanvas.toBlob(async (blob) => {
                const file = new File([blob], 'analysis.jpg', { type: 'image/jpeg' });
                await analyzeSnapshot(null, file);
            }, 'image/jpeg', 0.8);
        }

        async function analyzeSnapshot(snapshotId, file = null) {
            const sport = document.getElementById('sportSelect').value;
            const sportName = getSportName(sport);
            
            let imageFile = file;
            if (snapshotId && !file) {
                const snapshot = snapshots.find(s => s.id == snapshotId);
                if (!snapshot) return;
                
                // Convert base64 to file
                const response = await fetch(snapshot.image);
                const blob = await response.blob();
                imageFile = new File([blob], 'snapshot.jpg', { type: 'image/jpeg' });
            }
            
            showAnalysisHUD();
            
            const prompt = `ØªØ­Ù„ÙŠÙ„ Ù…ØªÙ‚Ø¯Ù… Ù„Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ù‚ØªØ§Ù„ÙŠØ© (${sportName}):

Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ù‚ØªØ§Ù„ÙŠ Ø®Ø¨ÙŠØ± Ù…ØªØ®ØµØµ ÙÙŠ ${sportName}. ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙˆØªÙ‚Ø¯ÙŠÙ… ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ ÙŠØªØ¶Ù…Ù†:

1. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹: ÙˆØµÙ Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„ÙÙ†ÙŠØ©ØŒ Ø§Ù„Ù…ÙˆÙ‚ÙØŒ ÙˆØ£Ø¯Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
2. ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„: Ù‚Ø±Ø§Ø¡Ø© ØªÙƒØªÙŠÙƒÙŠØ© Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© ÙˆØ§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†  
3. Ø­ÙƒÙ… Ø§Ù„Ø³Ø§Ø­Ø©: ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ù‚Ø§Ù†ÙˆÙ† ${sportName}
4. ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø¨: Ù†ØµØ§Ø¦Ø­ Ø¹Ù…Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†

ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØªÙ‚Ù†ÙŠØ§Øª ${sportName} Ø§Ù„Ø±Ø³Ù…ÙŠØ©.`;
            
            try {
                await window.Poe.sendUserMessage(prompt, {
                    attachments: [imageFile],
                    handler: 'analysis-handler',
                    stream: true,
                    openChat: false
                });
            } catch (err) {
                showAnalysisError(err.message);
            }
        }

        function showAnalysisHUD() {
            document.getElementById('tacticalHUD').classList.remove('hidden');
            document.getElementById('tacticalHUD').classList.add('flex');
            
            // Reset loading states
            ['sequenceAnalysis', 'matchEvolution', 'refereeJudgment', 'cornerAdvice'].forEach(id => {
                const element = document.getElementById(id);
                element.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary"></div>
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
                    </div>
                `;
                element.className = 'text-gray-300 loading';
            });
        }

        function closeAnalysisHUD() {
            document.getElementById('tacticalHUD').classList.add('hidden');
            document.getElementById('tacticalHUD').classList.remove('flex');
        }

        function showAnalysisError(error) {
            ['sequenceAnalysis', 'matchEvolution', 'refereeJudgment', 'cornerAdvice'].forEach(id => {
                const element = document.getElementById(id);
                element.innerHTML = `<p class="text-red-400">Ø­Ø¯Ø« Ø®Ø·Ø£: ${error}</p>`;
            });
        }

        function saveAnalysisToArchive() {
            const sport = document.getElementById('sportSelect').value;
            const timestamp = document.getElementById('mainVideo').currentTime;
            
            // Get analysis content
            const sequenceAnalysis = document.getElementById('sequenceAnalysis').textContent;
            const matchEvolution = document.getElementById('matchEvolution').textContent;
            const refereeJudgment = document.getElementById('refereeJudgment').textContent;
            const cornerAdvice = document.getElementById('cornerAdvice').textContent;
            
            // Create snapshot for archive
            const video = document.getElementById('mainVideo');
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            captureCtx.drawImage(video, 0, 0);
            
            const report = {
                id: Date.now(),
                sport: getSportName(sport),
                timestamp: formatTime(timestamp),
                date: new Date().toLocaleDateString('ar-SA'),
                snapshot: captureCanvas.toDataURL('image/jpeg', 0.8),
                analysis: {
                    sequence: sequenceAnalysis,
                    evolution: matchEvolution,
                    referee: refereeJudgment,
                    advice: cornerAdvice
                }
            };
            
            analysisHistory.push(report);
            showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ');
        }

        function newAnalysis() {
            closeAnalysisHUD();
        }

        // Utility functions
        function showAlert(message) {
            // Create custom alert modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-morphism rounded-2xl p-6 max-w-sm w-full mx-4 text-center">
                    <div class="text-4xl mb-4">â„¹ï¸</div>
                    <p class="text-white mb-6">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="bg-primary hover:bg-purple-600 px-6 py-2 rounded-xl text-white">
                        Ø­Ø³Ù†Ø§Ù‹
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 3000);
        }

        function deleteSnapshot(snapshotId) {
            snapshots = snapshots.filter(s => s.id != snapshotId);
            
            // Remove from DOM
            const gallery = document.getElementById('snapshotGallery');
            const items = gallery.children;
            for (let item of items) {
                const deleteBtn = item.querySelector(`button[onclick="deleteSnapshot('${snapshotId}')"]`);
                if (deleteBtn) {
                    item.remove();
                    break;
                }
            }
            
            // Show empty message if no snapshots
            if (snapshots.length === 0) {
                gallery.innerHTML = '<p class="text-gray-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ù‚Ø·Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
            }
        }

        function viewReport(reportId) {
            const report = analysisHistory.find(r => r.id == reportId);
            if (!report) return;
            
            // Show report in HUD
            showAnalysisHUD();
            
            document.getElementById('sequenceAnalysis').innerHTML = report.analysis.sequence;
            document.getElementById('matchEvolution').innerHTML = report.analysis.evolution;
            document.getElementById('refereeJudgment').innerHTML = report.analysis.referee;
            document.getElementById('cornerAdvice').innerHTML = report.analysis.advice;
        }

        // Register Poe handlers
        if (window.Poe) {
            window.Poe.registerHandler('analysis-handler', (result) => {
                const response = result.responses[0];
                
                if (response.status === 'error') {
                    showAnalysisError(response.statusText || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„');
                    return;
                }
                
                if (response.content) {
                    // Parse the AI response and distribute to different sections
                    const content = response.content;
                    const sections = parseAnalysisResponse(content);
                    
                    if (sections.sequence) {
                        document.getElementById('sequenceAnalysis').innerHTML = sections.sequence;
                        document.getElementById('sequenceAnalysis').className = 'text-gray-300';
                    }
                    if (sections.evolution) {
                        document.getElementById('matchEvolution').innerHTML = sections.evolution;
                        document.getElementById('matchEvolution').className = 'text-gray-300';
                    }
                    if (sections.referee) {
                        document.getElementById('refereeJudgment').innerHTML = sections.referee;
                        document.getElementById('refereeJudgment').className = 'text-gray-300';
                    }
                    if (sections.advice) {
                        document.getElementById('cornerAdvice').innerHTML = sections.advice;
                        document.getElementById('cornerAdvice').className = 'text-gray-300';
                    }
                }
            });
            
            window.Poe.registerHandler('scouting-handler', (result) => {
                const response = result.responses[0];
                const resultsDiv = document.getElementById('scoutingResults');
                
                if (response.status === 'error') {
                    resultsDiv.innerHTML = `<p class="text-red-400">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ${response.statusText}</p>`;
                    return;
                }
                
                if (response.content) {
                    resultsDiv.innerHTML = `<div class="whitespace-pre-wrap">${response.content}</div>`;
                }
            });
        }

        function parseAnalysisResponse(content) {
            const sections = {};
            
            // Simple parsing based on keywords
            if (content.includes('ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹') || content.includes('1.')) {
                const sequenceMatch = content.match(/(?:ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø·Ø¹|1\.)([\s\S]*?)(?:ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„|2\.|$)/);
                if (sequenceMatch) sections.sequence = sequenceMatch[1].trim();
            }
            
            if (content.includes('ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„') || content.includes('2.')) {
                const evolutionMatch = content.match(/(?:ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„|2\.)([\s\S]*?)(?:Ø­ÙƒÙ… Ø§Ù„Ø³Ø§Ø­Ø©|3\.|$)/);
                if (evolutionMatch) sections.evolution = evolutionMatch[1].trim();
            }
            
            if (content.includes('Ø­ÙƒÙ… Ø§Ù„Ø³Ø§Ø­Ø©') || content.includes('3.')) {
                const refereeMatch = content.match(/(?:Ø­ÙƒÙ… Ø§Ù„Ø³Ø§Ø­Ø©|3\.)([\s\S]*?)(?:ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø¨|4\.|$)/);
                if (refereeMatch) sections.referee = refereeMatch[1].trim();
            }
            
            if (content.includes('ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø¨') || content.includes('4.')) {
                const adviceMatch = content.match(/(?:ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¯Ø±Ø¨|4\.)([\s\S]*?)$/);
                if (adviceMatch) sections.advice = adviceMatch[1].trim();
            }
            
            // Fallback: if no sections found, put all content in sequence
            if (Object.keys(sections).length === 0) {
                sections.sequence = content;
                sections.evolution = "ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ù…Ù‚Ø·Ø¹ Ø¢Ø®Ø± Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªØ·ÙˆØ± Ø§Ù„Ù†Ø²Ø§Ù„";
                sections.referee = "ÙŠØ­ØªØ§Ø¬ ØªØ­Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‚Ø§Ø·";
                sections.advice = "Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø¯ÙˆØ¡";
            }
            
            return sections;
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
    <script>
    async function send() {
      let prompt = document.getElementById("prompt").value;

      const res = await fetch('/api/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });

      const data = await res.json();
      document.getElementById("result").textContent = data.result;
    }
</script>

</body>
</html>